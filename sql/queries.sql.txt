-- consultas de catalogo y filtros
-- 1. Listar productos por categoria
SELECT p.nombre, p.precio, c.nombre AS categoria 
FROM productos p 
JOIN categorias c ON p.categoria_id = c.id;

-- 2. Buscar productos de categoria marcos metalicos
SELECT * FROM productos WHERE categoria_id = 1;

-- 3. productos de mas de 41000
SELECT * FROM productos WHERE precio > 41000;

-- 4. Listar productos mayor a menor
SELECT * FROM productos ORDER BY precio DESC;

-- 5. filtrar por palabra Clarity en nombre
SELECT * FROM productos WHERE nombre LIKE '%Clarity%';

-- 6. conteo productos por categoria
SELECT c.nombre, COUNT(p.id) AS total_productos 
FROM categorias c 
LEFT JOIN productos p ON c.id = p.categoria_id 
GROUP BY c.nombre;

-- 7. Lista productos con stock entre 0 y 5 unidades
SELECT * FROM productos WHERE stock BETWEEN 0 AND 5;

-- consultas de stock y clientes
-- 8. Reporte de stock bajo 5 unidades
SELECT nombre, stock FROM productos WHERE stock < 5;

-- 9. Producto sin stock
SELECT nombre FROM productos WHERE stock = 0;

-- 10. Listar clientes y correos
SELECT nombre, email FROM clientes;

-- 11. Clientes que han comprado 2 o mas veces
SELECT c.nombre, COUNT(p.id) AS total_pedidos 
FROM clientes c 
JOIN pedidos p ON c.id = p.cliente_id 
GROUP BY c.id HAVING total_pedidos >= 2;

-- 12. mostrar 3 productos con mayor stock
SELECT nombre, stock FROM productos ORDER BY stock DESC LIMIT 3;

-- 13. ontener producto con mayor precio
SELECT * FROM productos WHERE precio = (SELECT MAX(precio) FROM productos);

-- 14. Listar categorias con mas de 3 productos 
SELECT c.nombre FROM categorias c 
JOIN productos p ON c.id = p.categoria_id 
GROUP BY c.id HAVING COUNT(p.id) > 3;


-- kpis de ventas
-- 15. Total de ventas histÃ³ricas
SELECT SUM(total) AS gran_total_ventas FROM pedidos;

-- 16. promedio de pedidos
SELECT AVG(total) AS ticket_promedio FROM pedidos;

-- 17. 3 productos mas vendidos
SELECT p.nombre, SUM(d.cantidad) AS cantidad_vendida 
FROM detalle d 
JOIN productos p ON d.producto_id = p.id 
GROUP BY p.id ORDER BY cantidad_vendida DESC LIMIT 3;

-- 18. pedidos en el ultimo mes
SELECT * FROM pedidos WHERE fecha >= '2026-01-01';

-- 20. Listar productos con stock completo
SELECT nombre FROM productos 
WHERE id NOT IN (SELECT DISTINCT producto_id FROM detalle);

-- 21. Mostrar detalle de pedido por id
SELECT p.nombre, d.cantidad, d.precio_unitario 
FROM detalle d 
JOIN productos p ON d.producto_id = p.id 
WHERE d.pedido_id = 1;

-- 22. cantidad de pedidos por cliente
SELECT c.nombre, COUNT(p.id) AS num_pedidos 
FROM clientes c 
LEFT JOIN pedidos p ON c.id = p.cliente_id 
GROUP BY c.nombre;

-- 23. mes con mas ventas
SELECT MONTH(fecha) AS mes, SUM(total) AS total_mes 
FROM pedidos GROUP BY mes ORDER BY total_mes DESC LIMIT 1;

-- 24. promedio de precio por categoria
SELECT c.nombre, AVG(p.precio) AS precio_medio 
FROM categorias c 
JOIN productos p ON c.id = p.categoria_id 
GROUP BY c.nombre;

-- 25. Listar pedido con nombre y email
SELECT p.id, p.fecha, c.nombre, c.email, p.total 
FROM pedidos p 
JOIN clientes c ON p.cliente_id = c.id;


-- Transaccion crear pedido y actualizar stock

START TRANSACTION;
-- encabezado del pedido
INSERT INTO pedidos (cliente_id, total) VALUES (3, 38000.00);

-- Detalle del producto
INSERT INTO detalle (pedido_id, producto_id, cantidad, precio_unitario) 
VALUES (LAST_INSERT_ID(), 2, 1, 38000.00);

-- descuento de inventario
UPDATE productos SET stock = stock - 1 WHERE id = 2;

-- si esta todo ok enviamos
COMMIT;